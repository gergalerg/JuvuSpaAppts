{% extends "spa_base.html" %}
{% block html_head %}
<link rel="stylesheet/less" href="/static/spa_home.less" type="text/css">
<script src="/static/js/less.js" type="text/javascript"></script>

{# Treatments Outline Display ================================================= #}
<script id="proc_template" type="text/x-jquery-tmpl">
<div class="proc" data-bind="visible:supported">
    <span data-bind="text:name, click:make_current, style: { 'paddingLeft': '1.75em' }"></span>
</div>
</script>

<script id="proc_category_template" type="text/x-jquery-tmpl">
<div class="proc_display">
    <span data-bind="text:name"></span>
    <p data-bind="template: {name:'proc_template', foreach: children}"></p>
</div>
</script>

{# Accordion Display ================================================= #}
<script id="accordion_proc_template" type="text/x-jquery-tmpl">
<input class="tile" type="checkbox" data-bind="event: {change:toggle}, attr: { id: 'check_' + name, name: 'check_' + name }"/>
<label data-bind="attr: { for: 'check_' + name }, text:name"></label>
<br>
</script>

<script id="accordion_proc_category_template" type="text/x-jquery-tmpl">
<h3><a href="#" data-bind="text:name"></a></h3>
<div data-bind="template: {name:'accordion_proc_template', foreach: children}"></div>
</script>
{# ================================================= #}

<script type="text/javascript">

function toc_in() {
    $("#toc").switchClass("seven", "two", 500, 'easeOutBounce', function() {
        $("#main_frame").fadeIn();
    });
}

function toc_out() {
    $("#main_frame").fadeOut(150, function() {
        $("#toc").switchClass("two", "seven", 150);
    });
}

function setup_button(sel, ico) {
    $(sel).button({icons: {primary:ico}, text: false })
        .click(function(){return false});
}


//-------------------------------------------------------
// Static Data
//

var root = {{ tree_data|safe }};


//-------------------------------------------------------
// View Model
//

var SpaProcedure = function(options) {
    this.name = options.name;
    this.nickname = ko.observable(options.name);
    this.supported = ko.observable(options.supported);

    if (!_.isUndefined(options.children)) {
        this.children = _.map(
            options.children,
            function(n) { return new SpaProcedure(n) }
        );
    }

    this.price = ko.observable(0.0);
    this.duration = ko.observable(60);

    this.formatted_price = ko.dependentObservable(function() {
        return "$" + (+this.price()).toFixed(2);
    }, this);

    this.toggle = function() {
        this.supported(!this.supported());
    }

    this.make_current = function() {
        viewModel.current_proc(this);
    }

    this.add_subtype = function() {
        console.log(this.name);
    }
}

// Convert the (server-embedded) JSON to KO models.
root.children = _.map(root.children, function(n) { return new SpaProcedure(n); });


//-------------------------------------------------------
// View Model
//

var viewModel = {

    // Track the current "view" the user is looking at.
    viewing: ko.observable(),

    // The currently selected treatment ("proc"edure), if any.
    current_proc: ko.observable({name:'None Selected'}),

    // The master tree of spa procedures.
    obj_treatments: ko.observableArray(root.children),

    add_subtype: function () {
        viewModel.current_proc().add_subtype();
    }
};

//-------------------------------------------------------
// View
//

var View = {
    // This is the last view the user was looking at, used for determining correct transition to a new view.
    previous_view: "toc",

};

// Update the "indicate" CSS class.
viewModel.viewing.subscribe(function(view) {
    $(".indicate").removeClass("indicate");
    $("#" + view + "_link").addClass("indicate");
});

// Track and update visible pane and TOC width.
viewModel.viewing.subscribe(function(view) {

    // I think this is prevented by the routes thingy, but it can't hurt.
    if (view == View.previous_view) { return };

    // Are we going to the TOC?
    if (view == "toc") {
        toc_out(); // The rest of the UI remains static,

    // No, we're going to one of the panes.
    } else {
        // Clear the previous view.
        if (View.previous_view == "toc") {
            toc_in();
            $(".current_pane").hide().removeClass("current_pane");
            $("#pane_" + view).show().addClass("current_pane");
        } else {
            $(".current_pane").hide("slide", 175, function() {
                $("#pane_" + view).show("slide", 175).addClass("current_pane");
            }).removeClass("current_pane");
        }
    };

    // Update history for next call.
    View.previous_view = view;
});

//-------------------------------------------------------
// Route URLs.
//

var routey = Backbone.Router.extend({

    routes: {
        "toc": "toc",
        "step/:num": "step",
    },

    toc: function() {
        viewModel.viewing("toc");
    },

    step: function(num) {
        num = +num;
        if (num >= 0 && num <= 4) {
            viewModel.viewing(num);
        } else {
            routes.navigate("toc", true);
        }
    },

});

var routes = new routey();

//-------------------------------------------------------
// Initial bootstrap.
//

$(function(){

    $("#main_frame").hide();
    $(".pane").hide();

    ko.applyBindings(viewModel);

    $("#choose").accordion({
        collapsible: true,
        autoHeight: false,
        create: function(event, ui) {
            $(this).accordion("activate", false);
        }
    });
    $("input.tile").button();

//    setup_button("button#add_staff", 'ui-icon-circle-plus');
    setup_button("button#add_proc", 'ui-icon-circle-plus');
    setup_button("button#del_proc", 'ui-icon-circle-close');

    crambery(3);

    if (!Backbone.history.start()) {
        routes.navigate("toc", true);
    }
});
</script>
{% endblock %}

{% block title %}Spa Home{% endblock %}

{% block header %}
<div id="title_bar">
  <h1>{{ spa_name|default:"&lt;SPA NAME&gt;" }}</h1> <h3 data-bind="text:viewing">Home</h3>
</div>
{% endblock %}

{% block toc %}
    <h3><a id="0_link" href="#step/0">Info</a></h3>
    <h3><a id="1_link" href="#step/1">Services</a></h3>
    <h3><a id="2_link" href="#step/2">Customize</a></h3>
    <h3><a id="3_link" href="#step/3">Staff</a></h3>
    <h3><a id="4_link" href="#step/4">Calendar</a></h3>
{% endblock %}

{% block pane_0 %}
<table><form class="nice">{{ form }}</form></table>
{% endblock %}

{% block pane_1 %}<div class="row">

<div class="seven columns">
    <form>
    <div id="choose" data-bind="template: {name:'accordion_proc_category_template', foreach: obj_treatments}">
    </div>{# "choose" DIV #}
    </form>
</div>{# columns #}

<div class="five columns"><div class="magic">
  <h4>Wants pawn term, </h4>
  <p>
    ..dare worsted ladle gull hoe lift wetter murder inner
    ladle cordage, honor itch offer lodge dock florist. Disk ladle gull
    orphan worry ladle cluck wetter putty ladle rat hut, an fur disk
    raisin pimple colder Ladle Rat Rotten Hut.
  </p>
  <p data-bind="template: {name:'proc_category_template', foreach: obj_treatments}"></p>
</div>{#  magic #}</div>{# columns #}

</div>{# row #}
{% endblock %}

{% block pane_2 %}<div class="row">

<div class="three columns">
  <p data-bind="template: {name:'proc_category_template', foreach: obj_treatments}"></p>
</div>{# columns #}

<div class="nine columns">
<div class="proc_detail">
    <h3 data-bind="text: current_proc().name"></h3>
    <h5>Details</h5>
        <div class="sub_proc" data-bind="visible:current_proc().supported">
            <span data-bind="text:current_proc().nickname"></span>
            <span data-bind="text:current_proc().formatted_price"></span>
            <span data-bind="text:current_proc().duration"></span>
        </div>
        <form class="nice">
            <label for="aka_name">A.k.a.:</label><input name="aka_name" class="input-text" type="text" data-bind="value:current_proc().nickname" placeholder="None Selected"><br>
            <label for="price">Price:</label><input name="price" class="input-text" type="text" data-bind="value:current_proc().price" placeholder="Price"><br>
            <label for="duration">Minutes:</label><input name="duration" class="input-text" type="text" data-bind="value:current_proc().duration" placeholder="Duration"><br>
            <button id="add_proc" data-bind="click: add_subtype">Add</button>
            <button id="del_proc">Delete</button>
        </form>

</div>
</div>{# columns #}

</div>{# row #}
{% endblock %}

{% block pane_3 %}
placeholder for staff page
{% endblock %}

{% block pane_4 %}
placeholder for calendar page
{% endblock %}


{% block body %}
{% endblock %}
