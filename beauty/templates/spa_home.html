{% extends "spa_base.html" %}
{% block html_head %}
<link rel="stylesheet/less" href="/static/spa_home.less" type="text/css">
<script src="/static/js/less.js" type="text/javascript"></script>

{# StaffMember Procedures ================================================= #}
<script id="staff_proc_template" type="text/x-jquery-tmpl">
<div class="staff_proc">
    <input class="staff_proc_tile" type="checkbox" data-bind="checked:supported, attr: { id: 'check_' + name, name: 'check_' + name }"/>
    <label data-bind="attr: { for: 'check_' + name }">
        <span data-bind="text:nickname"></span>
        <span data-bind="text:duration"></span>
        <span data-bind="text:formatted_price"></span>
    </label>
</div>
</script>

{# StaffMember ================================================= #}
<script id="tile_template" type="text/x-jquery-tmpl">
<div class="tile">
    <a href="#" data-bind="text:name, click: make_current"></a>
</div>
</script>

{# StaffMember under Calendar on TOC =============================== #}
<script id="toc_staff_template" type="text/x-jquery-tmpl">
<h5 data-bind="text:name, style: {backgroundColor:tag_color()}"></h5>
</script>

{# Treatments Outline Display ================================================= #}
<script id="proc_template4" type="text/x-jquery-tmpl">
<div class="proc">
  <input type="checkbox" data-bind="attr:{id:('id_'+nickname()+'_also'), name:nickname}" />
  <label data-bind="text:nickname, attr:{for:('id_'+nickname()+'_also')}"></label>
  <a style="cursor:pointer" data-bind="click:make_current">@</a>
</div>
</script>

<script id="proc_template3" type="text/x-jquery-tmpl">
<div class="proc">
  <input type="checkbox" data-bind="attr:{id:('id_'+nickname()), name:nickname}" />
  <label data-bind="text:nickname, attr:{for:('id_'+nickname())}"></label>
  <a style="cursor:pointer" data-bind="click:make_current">@</a>
</div>
</script>

<script id="proc_template2" type="text/x-jquery-tmpl">
<div class="proc" data-bind="click:make_current">
    <span data-bind="text:nickname"></span>
    <span data-bind="text:duration"></span>
    <span data-bind="text:formatted_price"></span>
</div>
</script>

<script id="proc_template" type="text/x-jquery-tmpl">
<div class="proc" data-bind="visible:supported">
    <span data-bind="text:name, click:make_current, style: { 'paddingLeft': '1.75em' }"></span>
</div>
</script>

<script id="proc_category_template" type="text/x-jquery-tmpl">
<div class="proc_display">
    <span data-bind="text:name"></span>
    <p data-bind="template: {name:'proc_template', foreach: children}"></p>
</div>
</script>

{# Accordion Display ================================================= #}
<script id="accordion_proc_template" type="text/x-jquery-tmpl">
<input class="tile" type="radio" data-bind="event: {change:toggle}, attr: { id: 'rad_' + name, value: name, name: 'proctastic' }"/>
<label data-bind="attr: { for: 'rad_' + name }, text:name"></label>
<br>
<div style="padding-left:1.5em" data-bind="template: {name:'accordion_proc_template', foreach: children}"></div>
</script>

<script id="accordion_proc_category_template" type="text/x-jquery-tmpl">
<h3><a href="#" data-bind="text:name"></a></h3>
<div data-bind="template: {name:'accordion_proc_template', foreach: children}"></div>
</script>
{# ================================================= #}

{# Staff Classes Display ================================================= #}
<script id="staff_classes_template" type="text/x-jquery-tmpl">
<li data-bind="text:name"></li>
</script>
<script id="staff_classes_checkbox_template" type="text/x-jquery-tmpl">
<input type="checkbox" data-bind="attr:{id:('id_'+name), name:name}" ><label data-bind="text:name, attr:{for:('id_'+name)}"></label><br>
</script>
{# ================================================= #}

{# Subtypes Display ================================================= #}
<script id="subtypes_template" type="text/x-jquery-tmpl">
<a style="cursor:pointer" data-bind="click:make_current, text:nickname, attr:{href:name}"></a><br>
</script>
{# ================================================= #}



<script type="text/javascript">


function random_apts(staff_member) {
    var res = [Math.random(), Math.random(), Math.random(), Math.random(), Math.random(), Math.random()];
    res.sort();
    res = _.map(res, day_to_n.invert);
    return [
        { start: res[0], end: res[1], staff_member: staff_member },
        { start: res[2], end: res[3], staff_member: staff_member },
        { start: res[4], end: res[5], staff_member: staff_member }
    ];
}


//-------------------------------------------------------
// Staff member calendar view support.
//

var color_of = d3.scale.linear()
        .domain([0, 1])
        .range(["hsl(0, 50%, 70%)", "hsl(360, 50%, 70%)"])
        .interpolate(d3.interpolateHsl);

function setup_bands() {
    var R = _.range(viewModel.staff().length);
    var x = d3.scale.ordinal()
        .domain(R)
        .rangeBands([80, 645], 0.125);
    var col = d3.scale.ordinal()
        .domain(R)
        .rangePoints([0.0, 1.0], 0.5);

    _.each(viewModel.staff(), function(n, i) {
        n.tag_color(color_of(col(i)));
    });

    var Apointments = _.flatten(_.map(viewModel.staff(), random_apts));

    d3.select("svg")
      .selectAll("rect")
      .remove();

    d3.select("svg")
      .selectAll("rect")
      .data(Apointments)
      .enter().append("svg:rect")
        .attr("x", function(d) { return x(_.indexOf(viewModel.staff(), d.staff_member)) })
        .attr("width", x.rangeBand())
        .attr("y", function(d) { return day_line(d.start) })
        .attr("height", function(d) { return day_line(d.end) - day_line(d.start) })
        .attr("fill", function(d) { return d.staff_member.tag_color() })
        .on("mouseover", function(d) {
            viewModel.mouse_time(hour(d.start));
        });

}


//-------------------------------------------------------
// Miscellaneous functions.
//

function toc_in() {
    $("#toc").switchClass("seven", "two", 500, 'easeOutBounce', function() {
        $("#main_frame").fadeIn();
    });
}

function toc_out() {
    $("#main_frame").fadeOut(150, function() {
        $("#toc").switchClass("two", "seven", 150);
    });
}

function setup_button(sel, ico) {
    $(sel).button({icons: {primary:ico}, text: false })
        .click(function(){return false});
}

function params_into_object(d, initial) {
    _.each(d, function(foo) {
        initial[foo.name] = foo.value;
    });
}

function toggle_resources() {
    $("#resource_picker_inner").toggle("blind");
};

function toggle_staff_classs() {
    $("#staff_class_picker_inner").toggle("blind");
};

function toggle_addon_procs() {
    $("#addon_procs_picker_inner").toggle("blind");
};

function toggle_options_procs() {
    $("#addon_options_picker_inner").toggle("blind");
};


//-------------------------------------------------------
// RDF Processing.
//

var RDF_NS = { 
    rdf: 'http://www.w3.org/1999/02/22-rdf-syntax-ns#',
    rdfs: 'http://www.w3.org/2000/01/rdf-schema#',
    dc: 'http://purl.org/dc/elements/1.1/', 
    foaf: 'http://xmlns.com/foaf/0.1/'
    };
function new_triplestore() {
    return $.rdf.databank([],
    {
        base: 'http://choicedocs.com/ref/',
        namespaces: RDF_NS,
    }
)};
var TRIPLESTORE = new_triplestore();

TRIPLESTORE.add('_:creator a foaf:Person')
TRIPLESTORE.add('_:creator foaf:name "Bill"')
var Q = $.rdf({databank: TRIPLESTORE})
    .where('?person a foaf:Person')
    .where('?person foaf:name ?name')
    .each(function() {
        console.log(this.person.value, this.name.value);
    });


function post_new_staff_member(who) {
    var trip = new_triplestore();
    trip.add('_:newb rdfs:label "' + who + '"');
    var payload = trip.dump({format:'application/rdf+xml'})
    $.ajax({
        url: "{% url staff 'Larry' %}",
        type: 'POST',
        contentType: 'application/rdf+xml',
        data: payload,
        processData: false,
        success: function(data, textStatus, jqXHR) {
            console.log(data);
            var K = new_triplestore();
            K.load(data);
            console.log(K.dump());
        },
    });
}


//-------------------------------------------------------
// View Model Classes
//

var SpaProcedure = function(options) {
    this.name = options.name;
    this.supported = ko.observable(options.supported);

    if (!_.isUndefined(options.children)) {
        this.children = _.map(
            options.children,
            function(n) { return new SpaProcedure(n) }
        );
    } else {
        this.children = null;
    }

    if (_.isUndefined(options.nickname)) {
        this.nickname = ko.observable("");
    } else {
        this.nickname = ko.observable(options.nickname);
    }

    if (_.isUndefined(options.price)) {
        this.price = ko.observable(0.0);
    } else {
        this.price = ko.observable(options.price);
    }

    if (_.isUndefined(options.duration)) {
        this.duration = ko.observable(60);
    } else {
        this.duration = ko.observable(options.duration);
    }

    this.formatted_price = ko.dependentObservable(function() {
        return "$" + (+this.price()).toFixed(0);
    }, this);

    this.toggle = function() {
        this.supported(!this.supported());
        this.make_current();
    }

    this.make_current = function() {
        viewModel.current_proc(this);
    }

    if (_.isUndefined(options.subtypes)) {
        this.subtypes = ko.observableArray([]);
    } else {
        this.subtypes = options.subtypes;
    }

    this.add_subtype = function() {
        var new_subtype = $("form#add_subtype").serializeArray();
        var n = {name: this.name, supported:true, subtypes:this.subtypes};
        params_into_object(new_subtype, n);
        console.log(n);
        var newb = new SpaProcedure(n);
        this.subtypes.push(newb);
        viewModel.supported_procs.push(newb);
        this.nickname("");
    }
}

var StaffMember = function(options) {
    this.name = options.name;
    this.tag_color = ko.observable('#fff');

    this.remove = function() {
        viewModel.stuffs.remove(this);
        if (viewModel.stuffs().length == 0 || viewModel.current_staff_member() == this) {
            viewModel.current_staff_member({});
        }
    }

    this.make_current = function() {
        viewModel.current_staff_member(this);
    }
}


//-------------------------------------------------------
// Static Data
//

var root = {{ tree_data|safe }};

// Convert the (server-embedded) JSON to KO models.
root.children = _.map(root.children, function(n) { return new SpaProcedure(n); });

var staff = _.map({{ staff|safe }}, function(n) { return new StaffMember(n); });


//-------------------------------------------------------
// View Model
//

var viewModel = {

    // Track the current "view" the user is looking at.
    viewing: ko.observable(),

    // The currently selected treatment ("proc"edure), if any.
    current_proc: ko.observable({name:'None Selected', subtypes:[]}),

    // Array of SpaProcedure objects that a spa supports.
    supported_procs: ko.observableArray(),

    // The master tree of spa procedures.
    obj_treatments: ko.observableArray(root.children),

    // Staff members, and currently selected staff member.
    staff: ko.observableArray(staff),
    current_staff_member: ko.observable({}),
    staff_classes: ko.observableArray(),

    // Display the time corresponding to the mouse position on the calendar pane.
    mouse_time: ko.observableArray(),

    // A bit of indirection to allow binding to this callback before current_proc is specified.
    add_subtype: function () {
        viewModel.current_proc().add_subtype();
    },

    add_staff_member: function() {
        var name = $("#staff_name").val();
        if (name != "") {
            var newbie = new StaffMember({
                name: name,
                description: 'Bananas and Peanutbutter',
                extraCost: 0.25,
            })
            this.staff.push(newbie);
            this.current_staff_member(newbie);
            $("#staff_name").val('');
            setup_bands();
        } else {
            $("#staff_name").effect('highlight');
        }
    },

    add_class: function() {
        var new_class = $("#id_add_class").val();
        if (!new_class) { return }
        viewModel.staff_classes.push({name:new_class});
    },
};

viewModel.someone_selected = ko.dependentObservable(function() {
    return !_.isEmpty(this.current_staff_member());
}, viewModel);

viewModel.view_title = ko.dependentObservable(function() {
    var lookup = {
        'toc': 'Home',
        0: 'Info',
        1: 'Services',
        2: 'Customize',
        3: 'Staff',
        4: 'Calendar',
    };
    console.log(this.viewing());
    return lookup[this.viewing()];
}, viewModel);

//-------------------------------------------------------
// View
//

var View = {
    // This is the last view the user was looking at, used for determining correct transition to a new view.
    previous_view: "toc",

};

// Update the "indicate" CSS class.
viewModel.viewing.subscribe(function(view) {
    $(".indicate").removeClass("indicate");
    $("#" + view + "_link").addClass("indicate");
});

// Track and update visible pane and TOC width.
viewModel.viewing.subscribe(function(view) {

    // I think this is prevented by the routes thingy, but it can't hurt.
    if (view == View.previous_view) { return };

    // Are we going to the TOC?
    if (view == "toc") {
        toc_out(); // The rest of the UI remains static,

    // No, we're going to one of the panes.
    } else {
        // Clear the previous view.
        if (View.previous_view == "toc") {
            toc_in();
            $(".current_pane").hide().removeClass("current_pane");
            $("#pane_" + view).show().addClass("current_pane");
        } else {
            $(".current_pane").hide("fade", 175, function() {
                $("#pane_" + view).show("fade", 175).addClass("current_pane");
            }).removeClass("current_pane");
        }
    };

    // Update history for next call.
    View.previous_view = view;
});

//-------------------------------------------------------
// Route URLs.
//

var routey = Backbone.Router.extend({

    routes: {
        "toc": "toc",
        "step/:num": "step",
    },

    toc: function() {
        viewModel.viewing("toc");
    },

    step: function(num) {
        num = +num;
        if (num >= 0 && num <= 4) {
            viewModel.viewing(num);
        } else {
            routes.navigate("toc", true);
        }
    },

});

var routes = new routey();

//-------------------------------------------------------
// Initial bootstrap.
//

$(function(){

    $("#main_frame").hide();
    $(".pane").hide();
    $(".picker_inner").hide();

    ko.applyBindings(viewModel);

    $("#choose").accordion({
        collapsible: true,
        autoHeight: false,
        create: function(event, ui) {
            $(this).accordion("activate", false);
        }
    });
    $("input.tile").button();

    setup_button("button#add_staff", 'ui-icon-circle-plus');
    setup_button("button#add_proc", 'ui-icon-circle-plus');
    setup_button("button#del_proc", 'ui-icon-circle-close');
    setup_button("button#add_class", 'ui-icon-circle-plus');

    var vis = d3.select("#show")
        .append("svg:svg")
        .attr("width", w)
        .attr("height", h)
        .attr("id", "uncanny");
    make_timescale(vis);

    $("#slider").slider({
        max: 0.25,
        min: -0.25,
        step: 0.015625, // 0.5 / (8 * 4) i.e. by fifteen minutes's.
        orientation: 'vertical',
        animate: true,
        slide: function(event, ui) {
            slider_offset = ui.value;
            timescale_updater();
        },
    });

    setup_bands();

    crambery(3);

    if (!Backbone.history.start()) {
        routes.navigate("toc", true);
    }
});
</script>
{% endblock %}

{% block title %}Spa Home{% endblock %}

{% block header %}
<div id="title_bar">
  <h1>{{ spa_name|default:"&lt;SPA NAME&gt;" }}</h1> <h3 data-bind="text:view_title">Home</h3>
</div>
{% endblock %}

{% block toc %}
    <h3><a id="0_link" href="#step/0">Info</a></h3>
    <h3><a id="1_link" href="#step/1">Services</a></h3>
    <h3><a id="3_link" href="#step/3">Staff</a></h3>
    <h3><a id="4_link" href="#step/4">Calendar</a></h3>
      <div data-bind="visible:viewing()==4, template: {name:'toc_staff_template', foreach: staff}"></div>
{% endblock %}

{% block pane_0 %}
<table><form class="nice">{{ form }}
<tr>
  <th><label for="id_add_class">Add Staff Class:</label></th>
  <td>
    <input id="id_add_class" type="text" name="add_class_name" maxlength="100" />
    <button id="add_class" data-bind="click: add_class">Add</button>
    <ul id="staff_classes" data-bind="template: {name:'staff_classes_template', foreach: staff_classes}"></ul>
  </td>
</tr>

<tr>
  <th><label for="id_juvunoti">Juvu Notification:</label></th>
  <td>
    <p>This area not applicable for merchants using software that Juvu integrates with or using Juvu as their primary booking solution.
  </td>
</tr>

<tr>
  <th><label>Email:</label></th>
  <td>
    <input id="id_email_0" type="text" name="email_name_0" maxlength="100" />
    <input id="id_email_1" type="text" name="email_name_1" maxlength="100" />
    <input id="id_email_2" type="text" name="email_name_2" maxlength="100" />
  </td>
</tr>

<tr>
  <th><label for="id_">SMS Text Messages:</label></th>
  <td>
    <input id="id_sms_0" type="text" name="sms_name_0" maxlength="100" />
    <input id="id_sms_1" type="text" name="sms_name_1" maxlength="100" />
    <input id="id_sms_2" type="text" name="sms_name_2" maxlength="100" />
  </td>
</tr>

<tr>
  <th><label>Payment Types Accepted:</label></th>
  <td>
    <input type="checkbox" id="id_Cash" name="" />
    <label for="id_Cash">Cash</label>
    <br>
    <input type="checkbox" id="id_VisaMC" name="" />
    <label for="id_VisaMC">Visa/MC</label>
    <br>
    <input type="checkbox" id="id_Amex" name="" />
    <label for="id_Amex">Amex</label>
    <br>
    <input type="checkbox" id="id_Discover" name="" />
    <label for="id_Discover">Discover</label>
    <br>
    <input type="checkbox" id="id_pcheck" name="" />
    <label for="id_pcheck">Personal Check</label>
    <br>
    <input type="checkbox" id="id_spafinderaccept" name="" />
    <label for="id_spafinderaccept">Spa Finder</label>
    <br>
  </td>
</tr>
</form></table>
{% endblock %}

{% block pane_1 %}<div class="row">

<div class="seven columns">
    <form>
    <div id="choose" data-bind="template: {name:'accordion_proc_category_template', foreach: obj_treatments}">
    </div>{# "choose" DIV #}
    </form>
</div>{# columns #}

<div class="five columns"><div class="magic">
<div class="proc_detail">
    <h3 data-bind="text: current_proc().name"></h3>

    <div id="subtypes_listing"  data-bind="template: {name:'subtypes_template', foreach: current_proc().subtypes}"></div>

    <form id="add_subtype" class="nice">
        <label for="nickname">Name:</label><input name="nickname" class="input-text" type="text" data-bind="value:current_proc().nickname" placeholder="None Selected"><br>
        <label for="price">Price:</label><input name="price" class="input-text" type="text" data-bind="value:current_proc().price" placeholder="Price"><br>
        <label for="duration">Minutes:</label><input name="duration" class="input-text" type="text" data-bind="value:current_proc().duration" placeholder="Duration"><br>
        <div id="resource_picker">
          <a style="cursor:pointer" data-bind="click:toggle_resources">resources</a>
          <div id="resource_picker_inner" class="picker_inner">
            <input type="checkbox" class="" id="id_Tissue" name="Tissue"><label for="id_Tissue">Tissue</label><br>
            <input type="checkbox" class="" id="id_Wax" name="Wax"><label for="id_Wax">Wax</label><br>
            <input type="checkbox" class="" id="id_Towel" name="Towel"><label for="id_Towel">Towel</label><br>
          </div>
        </div>
        <div id="staff_class_picker">
          <a style="cursor:pointer" data-bind="click:toggle_staff_classs">staff class</a>
          <div id="staff_class_picker_inner" class="picker_inner" data-bind="template: {name:'staff_classes_checkbox_template', foreach: staff_classes}"></div>
        </div>

        <div id="options_procs_picker">
          <a style="cursor:pointer" data-bind="click:toggle_options_procs">options</a>
          <div id="addon_options_picker_inner" class="picker_inner" data-bind="template: {name:'proc_template3', foreach: supported_procs}"></div>
        </div>

        <div id="addon_procs_picker">
          <a style="cursor:pointer" data-bind="click:toggle_addon_procs">add-on services</a>
          <div id="addon_procs_picker_inner" class="picker_inner" data-bind="template: {name:'proc_template4', foreach: supported_procs}"></div>
        </div>

        <label for="id_description">Description:</label>
        <textarea name="Description" cols="40" rows="4" id="id_description"></textarea>

        <label for="id_Appointment_411">Appointment 411:</label>
        <textarea name="Appointment_411" cols="40" rows="4" id="id_Appointment_411"></textarea>

        <br>
        <button id="add_proc" data-bind="click: add_subtype">Add</button>
        <button id="del_proc">Delete</button>
    </form>
</div>{# proc_detail #}
</div>{# magic #}</div>{# columns #}

</div>{# row #}
{% endblock %}

{# no pane 2 #}

{% block pane_3 %}
  <div class="row">

  <div class="four columns"><div id="staff_list">
    <h2>Staff</h2>
    <p data-bind="template: {name:'tile_template', foreach: staff}"></p>
    <form class="nice">
      <button id="add_staff" data-bind="click: add_staff_member">Add Staff Member</button>
      <input id="staff_name" name="staff_name" class="input-text small" type="text" placeholder="Add Staff Member">
    </form>
  </div>{# staff_list #}</div>

  <div class="eight columns"><div id="boy">
    <div class="row"><div class="twelve columns">
      <div id="aa" class="cake">
        <h3 data-bind="text: current_staff_member().name"></h3>
        <div data-bind="visible:someone_selected">
        <div id="chart" data-bind="template: {name:'staff_proc_template', foreach: supported_procs}"></div>
        </div>
      </div>{# panel #}
    </div></div>{# columns row #}
  </div>{# boy #}</div>

  </div>{# row #}
{% endblock %}

{% block pane_4 %}
<div class="row">
<div class="one columns">
    <div id="slider"></div>
</div>{# columns #}
<div class="eleven columns">
    <div data-bind="text:mouse_time"></div>
    <div id="show"></div>
</div>{# columns #}
</div>{# row #}
{% endblock %}


{% block body %}
{% endblock %}
