<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta name="language" content="en">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta name="author" content="ChoiceDocs.com">
	<meta name="publisher" content="Agora Health Networks, Inc.">
	<meta name="copyright" content="Â©2011 Agora Health Networks, Inc. All rights reserved worldwide.">
	<meta http-equiv="pragma" content="no-cache">
    <link type="text/css" href="/static/css/vader/jquery-ui-1.8.16.custom.css" rel="stylesheet" />	
    <script type="text/javascript" src="/static/js/jquery-1.6.2.min.js"></script>
    <script type="text/javascript" src="/static/js/jquery-ui-1.8.16.custom.min.js"></script>
	<link rel="stylesheet" href="/static/style.css" type="text/css">
	<title>Beauty</title>
	<script type="text/javascript">

	$(function(){
		
		// Various API calls that (eventually) contact the server.
		var dispatch = {

		    drop_attempt: function(which, where) {
		        console.log('dropping', which.html(), 'in', trenche_id(where), '...');

		        // if (it's already in the trenche) { return false }

                var result = false;
		        $.ajax({
                    type: 'POST',
                    url: "{% url iapi %}",
                    async: false,
                    data: {
                        s: which.html(),
                        p: 'add_treatment_to_trenche',
                        o: trenche_id(where),
                    },
                    success: function(data) { result = data; },
                    dataType: 'json',
                });
		        return result;
		    },

		    drop_success: function(which, where) {
    		    var text = which.html();
		        make_trenche_tile(where, text);
		        console.log('dropped', text, 'in', trenche_id(where));
		    },

		    remove_attempt: function(which, where) {
		        // AJAX POST to server to remove the tile from the trenche
		        var s = which.find(".trenche_text").text()
                console.log("removing", s, 'from', trenche_id(where));
                return true;
		    },

		    remove_success: function(which, where) {
		        var s = which.find(".trenche_text").text()
                console.log("removed", s, 'from', trenche_id(where));
                which.fadeOut(333, function() { which.remove() });
		    },

		};

		function trenche_id(trenche) {
		    return $(trenche).find('h1').first().html();
		}

		function make_trenche_tile(where, text) {
	        // Create a "trenche_inner" div
	        var D = $(
	            '<div class="trenche_inner roundy">' +
	            '<span class="trenche_text">' +
	            text +
	            '</span>' +
	            '<a class="remove_button">remove</a>' +
	            '</div>'
	        );
	        // Bind its remove button.
	        D.find(".remove_button").click(function() {
	            if (dispatch.remove_attempt(D, where)) {
	                dispatch.remove_success(D, where);
	            }
	        });
            where.append(D);
		};

	    $( ".tile" ).draggable({ 
	        revert: 'invalid',
	        revertDuration: 333,
	        scroll: false,
	        stack: '.tile',
	        opacity: 0.75,
	        zIndex: 2700,
	        helper: 'clone',
	        appendTo: '#main',
	        containment: '#main',
	        start: function(event, ui) {
	            console.log("start dragging", $(this).html());
	        },
	        stop: function(event, ui) {
	            console.log("stopped dragging", $(this).html());
	        },
	    });

        $("#choose").accordion({
            collapsible: true,
            autoHeight: false,
            create: function(event, ui) {
                $(this).accordion("activate", false);
            }
        });

        $(".trenche").droppable({
            accept: '.tile',
            hoverClass: 'shiny',
            drop: function(event, ui) {
                var trenche = $(this);
                var treatment = ui.draggable;
                if (dispatch.drop_attempt(treatment, trenche)) {
                    dispatch.drop_success(treatment, trenche);
                }
            },
        });

});</script>
</head>
<body>
	<div id="main_outer"><div id="main" class="roundy">
	    <div id="choose" class="roundy">
	      {% for kind, treats in treatments %}
	        <h3><a href="#">{{ kind }}</a></h3>
	        <div>
	        {% for treatment in treats %}<div class="tile roundy">{{ treatment }}</div>
	        {% endfor %}
	        </div>
	      {% endfor %}
	    </div>{# "choose" DIV #}
	    <div id="trenches" class="roundy">
	        <div class="trenche roundy">
    	        <center><h1>A</h1></center>
	        </div>
	        <div class="trenche roundy">
    	        <center><h1>B</h1></center>
	        </div>
	        <div class="trenche roundy">
    	        <center><h1>C</h1></center>
	        </div>
</div>	</div></div>
</body>
</html>
